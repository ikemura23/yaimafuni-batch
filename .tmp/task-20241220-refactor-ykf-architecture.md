# YKFリファクタリング実装タスク

## Phase 1: 汎用共通モジュール作成

### タスク 1.1: 共通ディレクトリ作成
- [ ] `src/common/` ディレクトリを作成

### タスク 1.2: browser-helper.js 作成
- [ ] `src/common/browser-helper.js` を作成
- [ ] ブラウザ作成・ページ設定の共通処理を実装
- [ ] エラーハンドリングの共通化
- [ ] 設定可能なタイムアウト・ユーザーエージェント対応
- [ ] 動作確認

### タスク 1.3: port-mapper.js 作成
- [ ] `src/common/port-mapper.js` を作成
- [ ] 港名から港コードへの変換（設定可能）
- [ ] 港コードから港名への変換
- [ ] YKF用の港マッピング設定
- [ ] 動作確認

### タスク 1.4: status-mapper.js 作成
- [ ] `src/common/status-mapper.js` を作成
- [ ] 記号からステータスコードへの変換（設定可能）
- [ ] ステータスコードからテキストへの変換
- [ ] YKF用のステータスマッピング設定
- [ ] 動作確認

## Phase 2: YKF専用モジュール作成

### タスク 2.1: YKFディレクトリ作成
- [ ] `src/ykf/` ディレクトリを作成
- [ ] `src/ykf/scrapers/` ディレクトリを作成
- [ ] `src/ykf/transformers/` ディレクトリを作成

### タスク 2.2: 共通モジュールの動作確認
- [ ] `browser-helper.js` の動作確認（簡単なテストスクリプト作成）
- [ ] `port-mapper.js` の動作確認（YKF用設定での変換テスト）
- [ ] `status-mapper.js` の動作確認（YKF用設定での変換テスト）

## Phase 3: 段階的ファイル移行

### 第1段階: ykf_list.js の移行

#### タスク 3.1.1: 移行前準備
- [ ] 現在の `ykf_list.js` の動作を記録
- [ ] テストケースの準備
- [ ] バックアップの作成

#### タスク 3.1.2: スクレイピング処理分離
- [ ] `src/ykf/scrapers/list-scraper.js` を作成
- [ ] 一覧スクレイピング処理を分離
- [ ] 共通モジュールの利用
- [ ] 動作確認

#### タスク 3.1.3: データ変換処理分離
- [ ] `src/ykf/transformers/list-transformer.js` を作成
- [ ] 一覧データ変換処理を分離
- [ ] 共通モジュールの利用
- [ ] 動作確認

#### タスク 3.1.4: エントリーポイント再構築
- [ ] `ykf_list.js` をエントリーポイントとして再構築
- [ ] 分離したモジュールの利用
- [ ] エラーハンドリングの統一
- [ ] 動作確認

### 第2段階: ykf_time_and_announce.js の移行

#### タスク 3.2.1: 移行前準備
- [ ] 現在の `ykf_time_and_announce.js` の動作を記録
- [ ] テストケースの準備
- [ ] バックアップの作成

#### タスク 3.2.2: スクレイピング処理分離
- [ ] `src/ykf/scrapers/time-announce-scraper.js` を作成
- [ ] 時間・アナウンススクレイピング処理を分離
- [ ] 共通モジュールの利用
- [ ] 動作確認

#### タスク 3.2.3: データ変換処理分離
- [ ] `src/ykf/transformers/time-announce-transformer.js` を作成
- [ ] 時間・アナウンスデータ変換処理を分離
- [ ] 共通モジュールの利用
- [ ] 動作確認

#### タスク 3.2.4: エントリーポイント再構築
- [ ] `ykf_time_and_announce.js` をエントリーポイントとして再構築
- [ ] 分離したモジュールの利用
- [ ] エラーハンドリングの統一
- [ ] 動作確認

### 第3段階: detail_ykf.js の移行

#### タスク 3.3.1: 移行前準備
- [ ] 現在の `detail_ykf.js` の動作を記録
- [ ] テストケースの準備
- [ ] バックアップの作成

#### タスク 3.3.2: スクレイピング処理分離
- [ ] `src/ykf/scrapers/detail-scraper.js` を作成
- [ ] 詳細スクレイピング処理を分離
- [ ] 共通モジュールの利用
- [ ] 動作確認

#### タスク 3.3.3: データ変換処理分離
- [ ] `src/ykf/transformers/detail-transformer.js` を作成
- [ ] 詳細データ変換処理を分離
- [ ] 共通モジュールの利用
- [ ] 動作確認

#### タスク 3.3.4: エントリーポイント再構築
- [ ] `detail_ykf.js` をエントリーポイントとして再構築
- [ ] 分離したモジュールの利用
- [ ] エラーハンドリングの統一
- [ ] 動作確認

## Phase 4: 最終調整

### タスク 4.1: 共通モジュール最適化
- [ ] 共通モジュールのパフォーマンス最適化
- [ ] エラーハンドリングの統一
- [ ] ログ出力の統一

### タスク 4.2: 全体動作確認
- [ ] 全ファイルの動作確認
- [ ] パフォーマンステスト
- [ ] エラーケースのテスト

### タスク 4.3: ドキュメント更新
- [ ] README.md の更新
- [ ] コメントの追加・修正
- [ ] 設計ドキュメントの最終更新

## 動作確認チェックリスト

### 各段階での確認項目
- [ ] 同じ入力で同じ出力が得られる
  - 移行前後のスクレイピング結果を比較
  - Firebaseへの保存データを比較
- [ ] エラーハンドリングが正常に動作する
  - ネットワークエラー時の動作確認
  - セレクター変更時の動作確認
- [ ] パフォーマンスに大きな劣化がない
  - 実行時間の計測・比較
  - メモリ使用量の確認
- [ ] ログ出力が適切に行われる
  - 開始・終了ログの確認
  - エラーログの確認
- [ ] 既存の呼び出し元に影響がない
  - 外部からの呼び出しテスト
  - 戻り値の形式確認

### ロールバック手順
- [ ] 問題発生時のロールバック手順を準備
- [ ] 各段階でバックアップを保持
- [ ] 即座に前段階に戻せる体制を整備
